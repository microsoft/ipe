<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://microsoft.github.io/ipe/usage/deployment/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Deploying Policies - Integrity Policy Enforcement</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Integrity Policy Enforcement</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Usage</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../properties/" class="dropdown-item">Properties</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Deploying Policies</a>
</li>
                                    
<li>
    <a href="../examples/" class="dropdown-item">Example Policies</a>
</li>
                                    
<li>
    <a href="../events/" class="dropdown-item">Audit Events</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Technical</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../technical/threat-model/" class="dropdown-item">Threat Model</a>
</li>
                                    
<li>
    <a href="../../technical/diagrams/" class="dropdown-item">Technical Diagrams</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Other</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../faq/" class="dropdown-item">FAQ</a>
</li>
                                    
<li>
    <a href="../../presentations/" class="dropdown-item">Presentations</a>
</li>
                                    
<li>
    <a href="../../attribution/" class="dropdown-item">Attribution</a>
</li>
                                    
<li>
    <a href="../../license/" class="dropdown-item">License</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../properties/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../examples/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/microsoft/ipe/edit/master/docs/usage/deployment.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#deploying-policies" class="nav-link">Deploying Policies</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="deploying-policies">Deploying Policies</h1>
<p>Policies can be deployed from userspace through securityfs. These policies are signed through the PKCS#7 message format to enforce some level of authorization of the policies (prohibiting an attacker from gaining unconstrained root, and deploying an "allow all" policy). These policies must be signed by a certificate that chains to the <code>SYSTEM_TRUSTED_KEYRING</code>. With openssl, the policy can be signed by:</p>
<pre><code>openssl smime -sign \
   -in &quot;$MY_POLICY&quot; \
   -signer &quot;$MY_CERTIFICATE&quot; \
   -inkey &quot;$MY_PRIVATE_KEY&quot; \
   -noattr \
   -nodetach \
   -nosmimecap \
   -outform der \
   -out &quot;$MY_POLICY.p7b&quot;
</code></pre>
<p>Deploying the policies is done through securityfs, through the <code>new_policy</code> node. To deploy a policy, simply cat the file into the securityfs node:</p>
<pre><code>cat &quot;$MY_POLICY.p7b&quot; &gt; /sys/kernel/security/ipe/new_policy
</code></pre>
<p>Upon success, this will create one subdirectory under <code>/sys/kernel/security/ipe/policies/</code>. The subdirectory will be the <code>policy_name</code> field of the policy deployed, so for the example above, the directory will be <code>/sys/kernel/security/ipe/policies/Ex_Policy</code>. Within this directory, there will be seven files: <code>pkcs7</code>, <code>policy</code>, <code>name</code>, <code>version</code>, <code>active</code>, <code>update</code>, and <code>delete</code>.</p>
<p>The <code>pkcs7</code> file is read-only. Reading it returns the raw PKCS#7 data that was provided to the kernel, representing the policy. If the policy being read is the boot policy, this will return <code>ENOENT</code>, as it is not signed.</p>
<p>The <code>policy</code> file is read only. Reading it returns the PKCS#7 inner content of the policy, which will be the plain text policy.</p>
<p>The <code>active</code> file is used to set a policy as the currently active policy. This file is rw, and accepts a value of <code>"1"</code> to set the policy as active. Since only a single policy can be active at one time, all other policies will be marked inactive. The policy being marked active must have a policy version greater or equal to the currently-running version.</p>
<p>The <code>update</code> file is used to update a policy that is already present in the kernel. This file is write-only and accepts a PKCS#7 signed policy. Two checks will always be performed on this policy: First, the <code>policy_names</code> must match with the updated version and the existing version. Second the updated policy must have a policy version greater than or equal to the currently-running version. This is to prevent rollback attacks.</p>
<p>The <code>delete</code> file is used to remove a policy that is no longer needed. This file is write-only and accepts a value of <code>"1"</code> to delete the policy. On deletion, the securityfs node representing the policy will be removed. However, delete the current active policy is not allowed and will return an operation not permitted error.</p>
<p>Similarly, writing to both <code>update</code> and <code>new_policy</code> could result in bad message(policy syntax error) or file exists error. The latter error happens when trying to deploy a policy with a <code>policy_name</code> while the kernel already has a deployed policy with the same <code>policy_name</code>.</p>
<p>Deploying a policy will <em>not</em> cause IPE to start enforcing the policy. IPE will only enforce the policy marked active. Note that only one policy can be active at a time.</p>
<p>Once deployment is successful, the policy can be activated, by writing file <code>/sys/kernel/security/ipe/policies/$policy_name/active</code>. For example, the <code>Ex_Policy</code> can be activated by:</p>
<pre><code>echo 1 &gt; &quot;/sys/kernel/security/ipe/policies/Ex_Policy/active&quot;
</code></pre>
<p>From above point on, <code>Ex_Policy</code> is now the enforced policy on the system.</p>
<p>IPE also provides a way to delete policies. This can be done via the <code>delete</code> securityfs node, <code>/sys/kernel/security/ipe/policies/$policy_name/delete</code>. Writing <code>1</code> to that file deletes the policy:</p>
<pre><code>echo 1 &gt; &quot;/sys/kernel/security/ipe/policies/$policy_name/delete&quot;
</code></pre>
<p>There is only one requirement to delete a policy: the policy being deleted must be inactive.</p>
<p><strong>NOTE:</strong></p>
<p>If a traditional MAC system is enabled (SELinux, apparmor, smack), all writes to ipe's securityfs nodes require <code>CAP_MAC_ADMIN</code>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright (c) Microsoft. All rights reserved.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
